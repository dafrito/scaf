APP=@@PROJECT@@

# This must always contain a package-specific subdirectory
PKGDATADIR=${DATADIR}/${APP}

RPMDIR ?= $$HOME/rpmbuild

all: ${APP}
.PHONY: all

Makefile: Makefile.in configure
	./configure ${PREFIX}

${APP}: Makefile
	echo "#!/bin/bash"                                >$@-wip
	echo "# Autogenerated this executable at `date`" >>$@-wip
	echo "# DO NOT EDIT THIS FILE!"                  >>$@-wip
	echo                                             >>$@-wip
	echo "@@PROJECT_UPPER@@_INSTALLED=true"          >>$@-wip
	echo "@@PROJECT_UPPER@@=${BINDIR}/@@PROJECT@@"   >>$@-wip
	echo "@@PROJECT_UPPER@@DIR=${PKGDATADIR}"        >>$@-wip
	echo                                             >>$@-wip
	echo "source ${PKGDATADIR}/run.sh"               >>$@-wip
	chmod +x $@-wip
	chmod ugo-w $@-wip
	rm -f $@
	mv $@-wip $@

install: uninstall ${APP} | ${BINDIR} ${PKGDATADIR}
	test -n ${BINDIR}
	test -n ${PKGDATADIR}
	cp ${APP} ${BINDIR}
	cp -r *.sh ${PKGDATADIR}
.PHONY: clean

${BINDIR} ${PKGDATADIR}:
	mkdir -p $@

tarfile=$(APP).tar.gz

dist-gzip: $(tarfile)
.PHONY: tar

$(tarfile): $(APP) *.sh configure Makefile.in
	tar czf $@ \
		--exclude-vcs \
		--exclude-backups \
		--exclude='release/**' \
		--exclude='**-wip' \
		--transform='s,^,$(APP)/,g' \
		$^;

spec: $(APP).spec
.PHONY: spec

$(APP).spec: rpm.spec.in
	echo "%define fullname $(APP)"       >$@-wip
	echo                                >>$@-wip
	echo "Name: $(APP)"                 >>$@-wip
	cat $^                              >>$@-wip
	mv $@-wip $@

rpm: dist-gzip $(APP).spec | $(RPMDIR)
	cp -u $(tarfile) $(RPMDIR)/SOURCES
	cp -u $(APP).spec $(RPMDIR)/SPECS
	rpmbuild --ba $(RPMDIR)/SPECS/$(APP).spec
	for package in `rpm -q --specfile ./$(APP).spec`; do \
		arch=`echo $$package | grep -E -o '[^.]+$$'`; \
		filename="$(RPMDIR)/RPMS/$$arch/$$package.rpm"; \
		[ -e `basename $$filename` ] || ln -s $$filename; \
	done
.PHONY: rpm

$(RPMDIR):
	mkdir -p $@
	cd $@ && mkdir -p SOURCES SPECS BUILD RPMS SRPMS

uninstall:
	# Verify these variables are given
	test -n ${BINDIR}
	test -n ${APP}
	test -n ${PKGDATADIR}
	rm -f ${BINDIR}/${APP}
	rm -rf ${PKGDATADIR}
.PHONY: uninstall

clean:
	rm -f ${APP} *-wip
.PHONY: clean

realclean: clean
	rm -f Makefile
.PHONY: realclean
